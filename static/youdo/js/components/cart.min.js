"use strict";function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,o)}return r}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(r,!0).forEach(function(t){_defineProperty(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(r).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}!function(){axios.defaults.baseURL=window.location.origin;var e=1,t=10;Vue.component("free-service-item",{delimiters:["[[","]]"],template:"#free-service-item",props:{freeCartItem:Object}}),Vue.component("service-item",{delimiters:["[[","]]"],template:"#service-item",props:{cartItem:Object,removeFromCart:Function,renderOrderUpdateResult:Function,markFreeItem:Function},data:function(){return{cartItemInfo:Object}},created:function(){},computed:{getItemLink:function(){var e=this.cartItem.item,t=e.object_type,r=e.id;return"".concat(t.toLowerCase(),"/").concat(r)}},methods:{updateCartItem:function(e){var t=this,r=new FormData,o=this.cartItem,i=o.uuid,n=o.count,a=this.$attrs["order-uuid"];if(r.append("uuid",i),r.append("csrfmiddlewaretoken",window.utils.csrfToken),this.cartItem.item.hasOwnProperty("services")){var c=this.cartItem.item.services.filter(function(t){return t.id===e})[0];r.append("service_id",c.id),r.append("service_count",c.in_order_count)}else r.append("count",n);axios.post("api/order/".concat(a,"/item/update"),r).then(function(e){var r=e.data;t.renderOrderUpdateResult(r)})},changePackageServiceAmount:function(r,o){var i=this.cartItem,n=i.item,a=n.services,c=n.price,s=i.count,d=a.filter(function(e){return e.id===r})[0];if(t>=d.in_order_count>=e){switch(o){case"plus":d.in_order_count<t&&(d.in_order_count+=1);break;case"minus":d.in_order_count>d.default_count&&(d.in_order_count-=1)}d.additional_price=(d.in_order_count-d.default_count)*d.price,this.cartItem.total_price=c*s+d.additional_price,this.updateCartItem(r)}},changeServiceAmount:function(r,o){var i=this.cartItem.count;if(t>=i>=e){switch(o){case"plus":i<t&&(this.cartItem.count+=1);break;case"minus":i>e&&(this.cartItem.count-=1)}this.cartItem.total_price=this.cartItem.item.price*this.cartItem.count,this.updateCartItem()}}}});new Vue({delimiters:["[[","]]"],el:"#cart",data:function(){return{cartItems:[],freeCartItems:[],orderUUID:String,areItemsFetching:!0,totalCartSum:0,promocode:{discount:null,error:{text:"",status:!1}}}},computed:{isPromocodeActivated:function(){var e=this.promocode,t=e.discount,r=e.error.status;return t>0&&!1===r}},mounted:function(){this.orderUUID=this.$el.dataset.orderUuid,this.getInitialCartState()},methods:{getInitialCartState:function(){var e=this;void 0!==this.orderUUID&&axios.get("api/order/".concat(this.orderUUID)).then(function(t){var r,o=t.data;(r=e.cartItems).push.apply(r,_toConsumableArray(o.items)),e.totalCartSum=o.total_price,e.promocode.discount=o.promocode_discount,e.areItemsFetching=!1})},renderOrderUpdateResult:function(e){var t=e.order_total_price,r=e.order_items_count,o=document.querySelector(".header__button--cart"),i=o.querySelector(".header__cart-text"),n=o.querySelector(".header__orders-count"),a=document.querySelector(".quick-order__total-price");this.totalCartSum=t,a.innerText="".concat(t,"₽"),i.innerText="".concat(t,"₽"),Boolean(r)&&(n.innerText=r)},getFreeItemId:function(e){var t;return e.map(function(e){if(e.hasOwnProperty("is_free")&&void 0!==e.is_free)return t=e.item_uuid}),{free_item_uuid:t}},markFreeItem:function(e){var t=this,r=e.free_item_uuid,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.cartItems;this.freeCartItems=[],o.map(function(e){if(e.item_uuid===r)if(e.item_count>1){var o=_objectSpread({},e,{is_free:!0,item_count:1,item_total_price:"Бесплатно"});Vue.set(e,"is_free",!1),Vue.set(e,"isDecreasedByPromo",!0),e.isDecreased||(e.item_count-=1,e.isDecreased=!0),e.item_total_price=e.item_price*e.item_count,t.freeCartItems.push(o)}else Vue.set(e,"is_free",!0),Vue.set(e,"isDecreasedByPromo",!1),Vue.set(e,"item_total_price","Бесплатно"),Vue.set(e,"item_total_price","Бесплатно");else Vue.set(e,"is_free",!1),Vue.set(e,"isDecreasedByPromo",!1)})},removeFromCart:function(e){var t,r,o=this,i=new FormData;this.cartItems.map(function(t,o){if(t.item.id===e)return r=o}),t=this.cartItems[r].uuid,i.append("uuid",t),i.append("csrfmiddlewaretoken",window.utils.csrfToken),axios.post("api/order/".concat(this.orderUUID,"/item/remove"),i).then(function(e){var t=e.data,i=t.order_total_price,n=t.order_items_count,a=t.order_removed,c=t.item_info,s=c.name,d=c.id,u=c.price,m=c.category,p=c.quantity;if(Vue.delete(o.cartItems,r),Boolean(a))return window.location.reload();o.renderOrderUpdateResult({order_items_count:n,order_total_price:i}),dataLayer.push({event:"removeFromCart",ecommerce:{remove:{products:[{name:s,id:d,price:u,category:m,quantity:p}]}}})})},openPromocodeModal:function(e){window.modals.openModalWindow(e)},closePromocodeModal:function(e){window.modals.closeModalWindow(e.currentTarget.dataset.modalClose)},sendPromocode:function(e){var t=this;axios.post("api/order/".concat(this.orderUUID,"/promocode"),window.utils.collectFormData(e.target)).then(function(e){var r=e.data,o=r.order_total_price,i=r.promocode_discount;t.promocode.discount=i,t.promocode.error.text=null,t.promocode.error.status=!1,t.renderOrderUpdateResult({order_total_price:o}),setTimeout(function(){window.modals.closeModalWindow("promocode-modal")},1500)}).catch(function(e){var r=e.response.data.detail;t.promocode.error.text=r,t.promocode.error.status=!0})},removePromocode:function(){var e=this,t=new FormData;t.append("csrfmiddlewaretoken",window.utils.csrfToken),axios.post("/api/order/".concat(this.orderUUID,"/promocode/remove"),t).then(function(t){var r=t.data.order_total_price;e.renderOrderUpdateResult({order_total_price:r}),e.promocode.error.text=null,e.promocode.error.status=!1,e.promocode.discount=0})}}})}();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvY2FydC5qcyJdLCJuYW1lcyI6WyJheGlvcyIsImRlZmF1bHRzIiwiYmFzZVVSTCIsIndpbmRvdyIsImxvY2F0aW9uIiwib3JpZ2luIiwiY2FydENvbmZpZyIsIlZ1ZSIsImNvbXBvbmVudCIsImRlbGltaXRlcnMiLCJ0ZW1wbGF0ZSIsInByb3BzIiwiZnJlZUNhcnRJdGVtIiwiT2JqZWN0Iiwic2VydmljZU1pblZhbHVlIiwic2VydmljZU1heFZhbHVlIiwicmVtb3ZlRnJvbUNhcnQiLCJGdW5jdGlvbiIsImNhcnRJdGVtSW5mbyIsImNhcnRJdGVtIiwiX3RoaXMkY2FydEl0ZW0kaXRlbSIsInRoaXMiLCJyZW5kZXJPcmRlclVwZGF0ZVJlc3VsdCIsImNvbmNhdCIsIm9iamVjdF90eXBlIiwidG9Mb3dlckNhc2UiLCJpZCIsIm1ldGhvZHMiLCJ1cGRhdGVDYXJ0SXRlbSIsImNoYW5nZWRJdGVtSWQiLCJfdGhpcyIsImRhdGEiLCJGb3JtRGF0YSIsIl90aGlzJGNhcnRJdGVtIiwidXVpZCIsImNvdW50IiwiZ2V0SXRlbUxpbmsiLCIkYXR0cnMiLCJ1dGlscyIsImNzcmZUb2tlbiIsIml0ZW0iLCJoYXNPd25Qcm9wZXJ0eSIsInVwZGF0ZWRTZXJ2aWNlIiwic2VydmljZXMiLCJmaWx0ZXIiLCJfcmVmIiwiYXBwZW5kIiwiaW5fb3JkZXJfY291bnQiLCJvcmRlclVVSUQiLCJ0aGVuIiwiX3JlZjIiLCJjaGFuZ2VQYWNrYWdlU2VydmljZUFtb3VudCIsImNoYW5nZWRTZXJ2aWNlSWQiLCJhY3Rpb24iLCJfdGhpcyRjYXJ0SXRlbTIiLCJfdGhpcyRjYXJ0SXRlbTIkaXRlbSIsInByaWNlIiwidGFyZ2V0U2VydmljZSIsImRlZmF1bHRfY291bnQiLCJzZXJ2aWNlSWQiLCJ0b3RhbF9wcmljZSIsImFkZGl0aW9uYWxfcHJpY2UiLCJjaGFuZ2VTZXJ2aWNlQW1vdW50IiwiZWwiLCJjYXJ0SXRlbXMiLCJmcmVlQ2FydEl0ZW1zIiwiU3RyaW5nIiwiYXJlSXRlbXNGZXRjaGluZyIsInRvdGFsQ2FydFN1bSIsInByb21vY29kZSIsImRpc2NvdW50IiwiZXJyb3IiLCJ0ZXh0Iiwic3RhdHVzIiwiY29tcHV0ZWQiLCJpc1Byb21vY29kZUFjdGl2YXRlZCIsIl90aGlzJHByb21vY29kZSIsIiRlbCIsImRhdGFzZXQiLCJvcmRlclV1aWQiLCJnZXRJbml0aWFsQ2FydFN0YXRlIiwiX3RoaXMyIiwidW5kZWZpbmVkIiwiX3JlZjQiLCJfdGhpczIkY2FydEl0ZW1zIiwicHVzaCIsIml0ZW1zIiwicHJvbW9jb2RlX2Rpc2NvdW50IiwiX3JlZjUiLCJvcmRlcl9pdGVtc19jb3VudCIsImhlYWRlckJ1dHRvbkNhcnQiLCJkb2N1bWVudCIsInF1ZXJ5U2VsZWN0b3IiLCJidXR0b25UZXh0IiwiYnV0dG9uQ291bnRlciIsIm9yZGVyX3RvdGFsX3ByaWNlIiwiaW5uZXJUZXh0IiwiQm9vbGVhbiIsImdldEZyZWVJdGVtSWQiLCJjb2xsZWN0aW9uIiwibWFwIiwiaXRlbV91dWlkIiwiZnJlZV9pdGVtX3V1aWQiLCJtYXJrRnJlZUl0ZW0iLCJfdGhpczMiLCJfcmVmNiIsImFyZ3VtZW50cyIsImxlbmd0aCIsInRvdGFsT3JkZXJQcmljZSIsIml0ZW1fdG90YWxfcHJpY2UiLCJzZXQiLCJpc19mcmVlIiwiaXNEZWNyZWFzZWQiLCJpdGVtX2NvdW50IiwiaXRlbV9wcmljZSIsIm1hcmtlZEl0ZW0iLCJ0YXJnZXRJdGVtSWQiLCJkZWxldGVkSXRlbVVVSUQiLCJfdGhpczQiLCJyZXF1ZXN0RGF0YSIsImluZGV4IiwiX3JlZjciLCJyZW1vdmVJbmRleCIsInBvc3QiLCJfcmVmOCRkYXRhIiwiX3JlZjgiLCJvcmRlcl9yZW1vdmVkIiwiX3JlZjgkZGF0YSRpdGVtX2luZm8iLCJpdGVtX2luZm8iLCJuYW1lIiwiY2F0ZWdvcnkiLCJxdWFudGl0eSIsImRlbGV0ZSIsInJlbG9hZCIsImRhdGFMYXllciIsImVjb21tZXJjZSIsInJlbW92ZSIsInByb2R1Y3RzIiwib3BlblByb21vY29kZU1vZGFsIiwiZXZ0IiwiY2xvc2VQcm9tb2NvZGVNb2RhbCIsIm1vZGFsQ2xvc2UiLCJzZW5kUHJvbW9jb2RlIiwiX3RoaXM1IiwiY29sbGVjdEZvcm1EYXRhIiwidGFyZ2V0IiwiX3JlZjkiLCJfcmVmOSRkYXRhIiwic2V0VGltZW91dCIsIm1vZGFscyIsImNsb3NlTW9kYWxXaW5kb3ciLCJjYXRjaCIsIl9yZWYxMCIsImRldGFpbCIsInJlc3BvbnNlIiwicmVtb3ZlUHJvbW9jb2RlIiwiX3RoaXM2IiwiZmV0Y2hEYXRhIiwiY2xvc2VQb3B1cFRpbWUiXSwibWFwcGluZ3MiOiIwckNBQUEsV0FDRUEsTUFBTUMsU0FBU0MsUUFBVUMsT0FBT0MsU0FBU0MsT0FFekMsSUFBTUMsRUFDYSxFQURiQSxFQUVhLEdBR25CQyxJQUFJQyxVQUFVLG9CQUFxQixDQUNqQ0MsV0FBWSxDQUFDLEtBQU0sTUFDbkJDLFNBQVUscUJBQ1ZDLE1BQU8sQ0FDTEMsYUFBY0MsVUFabkJOLElBQUFDLFVBQU0sZUFBQSxDQUNMUixXQUFBLENBQWVFLEtBQUFBLE1BRWZRLFNBQU1KLGdCQUNKUSxNQUFBQSxDQUNBQyxTQUFBQSxPQUZGQyxlQUFBQyxTQUtJVCx3QkFBVVMsU0FDWlIsYUFBYVEsVUFFYk4sS0FBSyxXQUNIQyxNQUFBQSxDQURLTSxhQUFBTCxTQU1QSixRQWpCRyxhQW9CRFUsU0FBUSxDQUNSSCxZQUFBQSxXQUZLLElBQUFJLEVBQUFDLEtBQUFGLFNBR0xHLEtBQUFBLEVBSEtGLEVBR0xFLFlBQXlCTCxFQUhwQkcsRUFHb0JILEdBTkMsTUFBQSxHQUFBTSxPQUFBQyxFQUFBQyxjQUFBLEtBQUFGLE9BQUFHLEtBVW5CQyxRQUFQLENBVjBCQyxlQVUxQixTQVYwQkMsR0FBQSxJQUFBQyxFQUFBVCxLQUFBVSxFQUFBLElBQUFDLFNBQUFDLEVBaUJsQlosS0FBQUYsU0FBQWUsRUFqQmtCRCxFQWlCbEJDLEtBQUFDLEVBakJrQkYsRUFpQmxCRSxNQUNSQyxFQUFhZixLQUFBZ0IsT0FBQSxjQUlaLEdBSndCTixFQUNU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S0F1SVB1SCxFQXZJTyxJQUFBNUcsU0FBQTZILEVBQUEvRyxPQUFBLHNCQUFBM0MsT0FBQW1DLE1BQUFDLFdBMklZdkMsTUE0QmQySCxLQTVCYyxjQUFBcEcsT0E0QktGLEtBQUsyQixVQTVCVixxQkE0QndDNkcsR0EzQnpEN0osS0FDRzJILFNBQUFBLEdBQXVCM0UsSUFEMUIrQyxFQUMwQi9DLEVBRDFCakIsS0FBQWdFLGtCQUU2RDZELEVBQTVDN0Qsd0JBQTRDLENBQUFBLGtCQUFBQSxJQUN6RDZELEVBQU1FLFVBQUFBLE1BQWlCdEYsS0FBdkIsS0FFQW9GLEVBQUt2RixVQUFVQyxNQUFBQSxRQUFXaUIsRUFDMUJxRSxFQUFLdkYsVUFBVUUsU0FBZixRQTdTWiIsImZpbGUiOiJjb21wb25lbnRzL2NhcnQubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKCgpID0+IHtcbiAgYXhpb3MuZGVmYXVsdHMuYmFzZVVSTCA9IHdpbmRvdy5sb2NhdGlvbi5vcmlnaW47XG5cbiAgY29uc3QgY2FydENvbmZpZyA9IHtcbiAgICBzZXJ2aWNlTWluVmFsdWU6IDEsXG4gICAgc2VydmljZU1heFZhbHVlOiAxMCxcbiAgfTtcblxuICBWdWUuY29tcG9uZW50KCdmcmVlLXNlcnZpY2UtaXRlbScsIHtcbiAgICBkZWxpbWl0ZXJzOiBbJ1tbJywgJ11dJ10sXG4gICAgdGVtcGxhdGU6ICcjZnJlZS1zZXJ2aWNlLWl0ZW0nLFxuICAgIHByb3BzOiB7XG4gICAgICBmcmVlQ2FydEl0ZW06IE9iamVjdCxcbiAgICB9LFxuICB9KTtcblxuICBWdWUuY29tcG9uZW50KCdzZXJ2aWNlLWl0ZW0nLCB7XG4gICAgZGVsaW1pdGVyczogWydbWycsICddXSddLFxuICAgIHRlbXBsYXRlOiAnI3NlcnZpY2UtaXRlbScsXG4gICAgcHJvcHM6IHtcbiAgICAgIGNhcnRJdGVtOiBPYmplY3QsXG4gICAgICByZW1vdmVGcm9tQ2FydDogRnVuY3Rpb24sXG4gICAgICByZW5kZXJPcmRlclVwZGF0ZVJlc3VsdDogRnVuY3Rpb24sXG4gICAgICBtYXJrRnJlZUl0ZW06IEZ1bmN0aW9uXG4gICAgfSxcbiAgICBkYXRhOiAoKSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBjYXJ0SXRlbUluZm86IE9iamVjdCxcbiAgICAgIH1cbiAgICB9LFxuICAgIGNyZWF0ZWQoKSB7XG4gICAgfSxcblxuICAgIGNvbXB1dGVkOiB7XG4gICAgICBnZXRJdGVtTGluazogZnVuY3Rpb24gKCkge1xuICAgICAgICBjb25zdCB7aXRlbToge29iamVjdF90eXBlLCBpZH19ID0gdGhpcy5jYXJ0SXRlbTtcblxuICAgICAgICByZXR1cm4gYCR7b2JqZWN0X3R5cGUudG9Mb3dlckNhc2UoKX0vJHtpZH1gXG4gICAgICB9LFxuICAgIH0sXG5cbiAgICBtZXRob2RzOiB7XG4gICAgICB1cGRhdGVDYXJ0SXRlbShjaGFuZ2VkSXRlbUlkKSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgY29uc3Qge3V1aWQsIGNvdW50fSA9IHRoaXMuY2FydEl0ZW07XG4gICAgICAgIGNvbnN0IG9yZGVyVVVJRCA9IHRoaXMuJGF0dHJzWydvcmRlci11dWlkJ107XG5cbiAgICAgICAgZGF0YS5hcHBlbmQoJ3V1aWQnLCB1dWlkKTtcbiAgICAgICAgZGF0YS5hcHBlbmQoJ2NzcmZtaWRkbGV3YXJldG9rZW4nLCB3aW5kb3cudXRpbHMuY3NyZlRva2VuKTtcblxuICAgICAgICBpZiAodGhpcy5jYXJ0SXRlbS5pdGVtLmhhc093blByb3BlcnR5KCdzZXJ2aWNlcycpKSB7XG4gICAgICAgICAgY29uc3Qge3NlcnZpY2VzfSA9IHRoaXMuY2FydEl0ZW0uaXRlbTtcbiAgICAgICAgICBjb25zdCB1cGRhdGVkU2VydmljZSA9IHNlcnZpY2VzLmZpbHRlcigoe2lkfSkgPT4gKGlkID09PSBjaGFuZ2VkSXRlbUlkKSlbMF07XG5cbiAgICAgICAgICBkYXRhLmFwcGVuZCgnc2VydmljZV9pZCcsIHVwZGF0ZWRTZXJ2aWNlLmlkKTtcbiAgICAgICAgICBkYXRhLmFwcGVuZCgnc2VydmljZV9jb3VudCcsIHVwZGF0ZWRTZXJ2aWNlLmluX29yZGVyX2NvdW50KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkYXRhLmFwcGVuZCgnY291bnQnLCBjb3VudCk7XG4gICAgICAgIH1cblxuXG4gICAgICAgIGF4aW9zXG4gICAgICAgICAgLnBvc3QoYGFwaS9vcmRlci8ke29yZGVyVVVJRH0vaXRlbS91cGRhdGVgLCBkYXRhKVxuICAgICAgICAgIC50aGVuKCh7ZGF0YX0pID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyT3JkZXJVcGRhdGVSZXN1bHQoZGF0YSk7XG4gICAgICAgICAgICAvLyB0aGlzLm1hcmtGcmVlSXRlbShkYXRhKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH0sXG5cbiAgICAgIGNoYW5nZVBhY2thZ2VTZXJ2aWNlQW1vdW50KGNoYW5nZWRTZXJ2aWNlSWQsIGFjdGlvbikge1xuICAgICAgICBjb25zdCB7aXRlbToge3NlcnZpY2VzLCBwcmljZX0sIGNvdW50fSA9IHRoaXMuY2FydEl0ZW07XG4gICAgICAgIGNvbnN0IHRhcmdldFNlcnZpY2UgPSBzZXJ2aWNlcy5maWx0ZXIoKHtpZDogc2VydmljZUlkfSkgPT4gc2VydmljZUlkID09PSBjaGFuZ2VkU2VydmljZUlkKVswXTtcblxuICAgICAgICBpZiAoY2FydENvbmZpZy5zZXJ2aWNlTWF4VmFsdWUgPj0gdGFyZ2V0U2VydmljZS5pbl9vcmRlcl9jb3VudCA+PSBjYXJ0Q29uZmlnLnNlcnZpY2VNaW5WYWx1ZSkge1xuICAgICAgICAgIHN3aXRjaCAoYWN0aW9uKSB7XG4gICAgICAgICAgICBjYXNlICdwbHVzJzpcbiAgICAgICAgICAgICAgaWYgKHRhcmdldFNlcnZpY2UuaW5fb3JkZXJfY291bnQgPCBjYXJ0Q29uZmlnLnNlcnZpY2VNYXhWYWx1ZSkge1xuICAgICAgICAgICAgICAgIHRhcmdldFNlcnZpY2UuaW5fb3JkZXJfY291bnQgKz0gMTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ21pbnVzJzpcbiAgICAgICAgICAgICAgaWYgKHRhcmdldFNlcnZpY2UuaW5fb3JkZXJfY291bnQgPiB0YXJnZXRTZXJ2aWNlLmRlZmF1bHRfY291bnQpIHtcbiAgICAgICAgICAgICAgICB0YXJnZXRTZXJ2aWNlLmluX29yZGVyX2NvdW50IC09IDE7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB0YXJnZXRTZXJ2aWNlLmFkZGl0aW9uYWxfcHJpY2UgPSAodGFyZ2V0U2VydmljZS5pbl9vcmRlcl9jb3VudCAtIHRhcmdldFNlcnZpY2UuZGVmYXVsdF9jb3VudCkgKiB0YXJnZXRTZXJ2aWNlLnByaWNlO1xuICAgICAgICAgIHRoaXMuY2FydEl0ZW0udG90YWxfcHJpY2UgPSBwcmljZSAqIGNvdW50ICsgdGFyZ2V0U2VydmljZS5hZGRpdGlvbmFsX3ByaWNlO1xuICAgICAgICAgIHRoaXMudXBkYXRlQ2FydEl0ZW0oY2hhbmdlZFNlcnZpY2VJZCk7XG4gICAgICAgIH1cbiAgICAgIH0sXG5cbiAgICAgIGNoYW5nZVNlcnZpY2VBbW91bnQoaWQsIGFjdGlvbikge1xuICAgICAgICBjb25zdCB7Y291bnR9ID0gdGhpcy5jYXJ0SXRlbTtcblxuICAgICAgICBpZiAoY2FydENvbmZpZy5zZXJ2aWNlTWF4VmFsdWUgPj0gY291bnQgPj0gY2FydENvbmZpZy5zZXJ2aWNlTWluVmFsdWUpIHtcbiAgICAgICAgICBzd2l0Y2ggKGFjdGlvbikge1xuICAgICAgICAgICAgY2FzZSAncGx1cyc6XG4gICAgICAgICAgICAgIGlmIChjb3VudCA8IGNhcnRDb25maWcuc2VydmljZU1heFZhbHVlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jYXJ0SXRlbS5jb3VudCArPSAxO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnbWludXMnOlxuICAgICAgICAgICAgICBpZiAoY291bnQgPiBjYXJ0Q29uZmlnLnNlcnZpY2VNaW5WYWx1ZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuY2FydEl0ZW0uY291bnQgLT0gMTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHRoaXMuY2FydEl0ZW0udG90YWxfcHJpY2UgPSB0aGlzLmNhcnRJdGVtLml0ZW0ucHJpY2UgKiB0aGlzLmNhcnRJdGVtLmNvdW50O1xuXG4gICAgICAgICAgdGhpcy51cGRhdGVDYXJ0SXRlbSgpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgIH1cbiAgfSk7XG5cbiAgY29uc3QgY2FydCA9IG5ldyBWdWUoe1xuICAgIGRlbGltaXRlcnM6IFsnW1snLCAnXV0nXSxcbiAgICBlbDogJyNjYXJ0JyxcbiAgICBkYXRhOiAoKSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBjYXJ0SXRlbXM6IFtdLFxuICAgICAgICBmcmVlQ2FydEl0ZW1zOiBbXSxcbiAgICAgICAgb3JkZXJVVUlEOiBTdHJpbmcsXG4gICAgICAgIGFyZUl0ZW1zRmV0Y2hpbmc6IHRydWUsXG4gICAgICAgIHRvdGFsQ2FydFN1bTogMCxcbiAgICAgICAgcHJvbW9jb2RlOiB7XG4gICAgICAgICAgZGlzY291bnQ6IG51bGwsXG4gICAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICAgIHRleHQ6ICcnLFxuICAgICAgICAgICAgc3RhdHVzOiBmYWxzZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfVxuICAgIH0sXG5cbiAgICBjb21wdXRlZDoge1xuICAgICAgaXNQcm9tb2NvZGVBY3RpdmF0ZWQoKSB7XG4gICAgICAgIGNvbnN0IHtkaXNjb3VudCwgZXJyb3I6IHtzdGF0dXN9fSA9IHRoaXMucHJvbW9jb2RlO1xuXG4gICAgICAgIHJldHVybiBkaXNjb3VudCA+IDAgJiYgc3RhdHVzID09PSBmYWxzZTtcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgbW91bnRlZCgpIHtcbiAgICAgIHRoaXMub3JkZXJVVUlEID0gdGhpcy4kZWwuZGF0YXNldC5vcmRlclV1aWQ7XG4gICAgICB0aGlzLmdldEluaXRpYWxDYXJ0U3RhdGUoKTtcbiAgICB9LFxuXG4gICAgbWV0aG9kczoge1xuICAgICAgZ2V0SW5pdGlhbENhcnRTdGF0ZSgpIHtcbiAgICAgICAgaWYgKHRoaXMub3JkZXJVVUlEICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBheGlvc1xuICAgICAgICAgICAgLmdldChgYXBpL29yZGVyLyR7dGhpcy5vcmRlclVVSUR9YClcbiAgICAgICAgICAgIC50aGVuKCh7ZGF0YX0pID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5jYXJ0SXRlbXMucHVzaCguLi5kYXRhLml0ZW1zKTtcbiAgICAgICAgICAgICAgdGhpcy50b3RhbENhcnRTdW0gPSBkYXRhLnRvdGFsX3ByaWNlO1xuICAgICAgICAgICAgICB0aGlzLnByb21vY29kZS5kaXNjb3VudCA9IGRhdGEucHJvbW9jb2RlX2Rpc2NvdW50O1xuICAgICAgICAgICAgICB0aGlzLmFyZUl0ZW1zRmV0Y2hpbmcgPSBmYWxzZTtcblxuICAgICAgICAgICAgICAvLyBjb25zdCBmcmVlSXRlbUlEID0gdGhpcy5nZXRGcmVlSXRlbUlkKGRhdGEpO1xuICAgICAgICAgICAgICAvLyB0aGlzLm1hcmtGcmVlSXRlbShmcmVlSXRlbUlEKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9LFxuXG4gICAgICByZW5kZXJPcmRlclVwZGF0ZVJlc3VsdCh7b3JkZXJfdG90YWxfcHJpY2UsIG9yZGVyX2l0ZW1zX2NvdW50fSkge1xuICAgICAgICBjb25zdCBoZWFkZXJCdXR0b25DYXJ0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmhlYWRlcl9fYnV0dG9uLS1jYXJ0Jyk7XG4gICAgICAgIGNvbnN0IGJ1dHRvblRleHQgPSBoZWFkZXJCdXR0b25DYXJ0LnF1ZXJ5U2VsZWN0b3IoJy5oZWFkZXJfX2NhcnQtdGV4dCcpO1xuICAgICAgICBjb25zdCBidXR0b25Db3VudGVyID0gaGVhZGVyQnV0dG9uQ2FydC5xdWVyeVNlbGVjdG9yKCcuaGVhZGVyX19vcmRlcnMtY291bnQnKTtcbiAgICAgICAgY29uc3QgdG90YWxPcmRlclByaWNlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnF1aWNrLW9yZGVyX190b3RhbC1wcmljZScpO1xuXG4gICAgICAgIHRoaXMudG90YWxDYXJ0U3VtID0gb3JkZXJfdG90YWxfcHJpY2U7XG5cbiAgICAgICAgdG90YWxPcmRlclByaWNlLmlubmVyVGV4dCA9IGAke29yZGVyX3RvdGFsX3ByaWNlfeKCvWA7XG4gICAgICAgIGJ1dHRvblRleHQuaW5uZXJUZXh0ID0gYCR7b3JkZXJfdG90YWxfcHJpY2V94oK9YDtcbiAgICAgICAgKEJvb2xlYW4ob3JkZXJfaXRlbXNfY291bnQpKSA/IGJ1dHRvbkNvdW50ZXIuaW5uZXJUZXh0ID0gb3JkZXJfaXRlbXNfY291bnQgOiBudWxsO1xuICAgICAgfSxcblxuICAgICAgZ2V0RnJlZUl0ZW1JZChjb2xsZWN0aW9uKSB7XG4gICAgICAgIGxldCBpZDtcblxuICAgICAgICBjb2xsZWN0aW9uLm1hcCgoaXRlbSkgPT4ge1xuICAgICAgICAgIGlmIChpdGVtLmhhc093blByb3BlcnR5KCdpc19mcmVlJykgJiYgaXRlbS5pc19mcmVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBpZCA9IGl0ZW0uaXRlbV91dWlkO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBmcmVlX2l0ZW1fdXVpZDogaWRcbiAgICAgICAgfVxuICAgICAgfSxcblxuICAgICAgbWFya0ZyZWVJdGVtKHtmcmVlX2l0ZW1fdXVpZH0sIGNhcnRJdGVtcyA9IHRoaXMuY2FydEl0ZW1zKSB7XG4gICAgICAgIHRoaXMuZnJlZUNhcnRJdGVtcyA9IFtdO1xuXG4gICAgICAgIGNhcnRJdGVtcy5tYXAoKGNhcnRJdGVtKSA9PiB7XG4gICAgICAgICAgaWYgKGNhcnRJdGVtLml0ZW1fdXVpZCA9PT0gZnJlZV9pdGVtX3V1aWQpIHtcbiAgICAgICAgICAgIGlmIChjYXJ0SXRlbS5pdGVtX2NvdW50ID4gMSkge1xuICAgICAgICAgICAgICBjb25zdCBtYXJrZWRJdGVtID0ge1xuICAgICAgICAgICAgICAgIC4uLmNhcnRJdGVtLFxuICAgICAgICAgICAgICAgIGlzX2ZyZWU6IHRydWUsXG4gICAgICAgICAgICAgICAgaXRlbV9jb3VudDogMSxcbiAgICAgICAgICAgICAgICBpdGVtX3RvdGFsX3ByaWNlOiBg0JHQtdGB0L/Qu9Cw0YLQvdC+YCxcbiAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICBWdWUuc2V0KGNhcnRJdGVtLCAnaXNfZnJlZScsIGZhbHNlKTtcbiAgICAgICAgICAgICAgVnVlLnNldChjYXJ0SXRlbSwgJ2lzRGVjcmVhc2VkQnlQcm9tbycsIHRydWUpO1xuXG4gICAgICAgICAgICAgIGlmICghY2FydEl0ZW0uaXNEZWNyZWFzZWQpIHtcbiAgICAgICAgICAgICAgICBjYXJ0SXRlbS5pdGVtX2NvdW50IC09IDE7XG4gICAgICAgICAgICAgICAgY2FydEl0ZW0uaXNEZWNyZWFzZWQgPSB0cnVlO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgY2FydEl0ZW0uaXRlbV90b3RhbF9wcmljZSA9IGNhcnRJdGVtLml0ZW1fcHJpY2UgKiBjYXJ0SXRlbS5pdGVtX2NvdW50O1xuXG4gICAgICAgICAgICAgIHRoaXMuZnJlZUNhcnRJdGVtcy5wdXNoKG1hcmtlZEl0ZW0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgVnVlLnNldChjYXJ0SXRlbSwgJ2lzX2ZyZWUnLCB0cnVlKTtcbiAgICAgICAgICAgICAgVnVlLnNldChjYXJ0SXRlbSwgJ2lzRGVjcmVhc2VkQnlQcm9tbycsIGZhbHNlKTtcbiAgICAgICAgICAgICAgVnVlLnNldChjYXJ0SXRlbSwgJ2l0ZW1fdG90YWxfcHJpY2UnLCBg0JHQtdGB0L/Qu9Cw0YLQvdC+YCk7XG4gICAgICAgICAgICAgIFZ1ZS5zZXQoY2FydEl0ZW0sICdpdGVtX3RvdGFsX3ByaWNlJywgYNCR0LXRgdC/0LvQsNGC0L3QvmApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIFZ1ZS5zZXQoY2FydEl0ZW0sICdpc19mcmVlJywgZmFsc2UpO1xuICAgICAgICAgICAgVnVlLnNldChjYXJ0SXRlbSwgJ2lzRGVjcmVhc2VkQnlQcm9tbycsIGZhbHNlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSxcblxuICAgICAgcmVtb3ZlRnJvbUNhcnQodGFyZ2V0SXRlbUlkKSB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3REYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgICAgIGxldCBkZWxldGVkSXRlbVVVSUQsIHJlbW92ZUluZGV4O1xuXG4gICAgICAgIHRoaXMuY2FydEl0ZW1zLm1hcCgoe2l0ZW06IHtpZH19LCBpbmRleCkgPT4ge1xuICAgICAgICAgIGlmIChpZCA9PT0gdGFyZ2V0SXRlbUlkKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVtb3ZlSW5kZXggPSBpbmRleDtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGRlbGV0ZWRJdGVtVVVJRCA9IHRoaXMuY2FydEl0ZW1zW3JlbW92ZUluZGV4XS51dWlkO1xuXG4gICAgICAgIHJlcXVlc3REYXRhLmFwcGVuZCgndXVpZCcsIGRlbGV0ZWRJdGVtVVVJRCk7XG4gICAgICAgIHJlcXVlc3REYXRhLmFwcGVuZCgnY3NyZm1pZGRsZXdhcmV0b2tlbicsIHdpbmRvdy51dGlscy5jc3JmVG9rZW4pO1xuXG4gICAgICAgIGF4aW9zXG4gICAgICAgICAgLnBvc3QoYGFwaS9vcmRlci8ke3RoaXMub3JkZXJVVUlEfS9pdGVtL3JlbW92ZWAsIHJlcXVlc3REYXRhKVxuICAgICAgICAgIC50aGVuKCh7ZGF0YToge29yZGVyX3RvdGFsX3ByaWNlLCBvcmRlcl9pdGVtc19jb3VudCwgb3JkZXJfcmVtb3ZlZCwgaXRlbV9pbmZvOiB7bmFtZSwgaWQsIHByaWNlLCBjYXRlZ29yeSwgcXVhbnRpdHl9fX0pID0+IHtcblxuICAgICAgICAgICAgVnVlLmRlbGV0ZSh0aGlzLmNhcnRJdGVtcywgcmVtb3ZlSW5kZXgpO1xuXG4gICAgICAgICAgICBpZiAoQm9vbGVhbihvcmRlcl9yZW1vdmVkKSkge1xuICAgICAgICAgICAgICByZXR1cm4gd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhpcy5yZW5kZXJPcmRlclVwZGF0ZVJlc3VsdCh7b3JkZXJfaXRlbXNfY291bnQsIG9yZGVyX3RvdGFsX3ByaWNlfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGRhdGFMYXllci5wdXNoKHtcbiAgICAgICAgICAgICAgJ2V2ZW50JzogJ3JlbW92ZUZyb21DYXJ0JyxcbiAgICAgICAgICAgICAgJ2Vjb21tZXJjZSc6IHtcbiAgICAgICAgICAgICAgICAncmVtb3ZlJzoge1xuICAgICAgICAgICAgICAgICAgJ3Byb2R1Y3RzJzogW3tcbiAgICAgICAgICAgICAgICAgICAgJ25hbWUnOiBuYW1lLFxuICAgICAgICAgICAgICAgICAgICAnaWQnOiBpZCxcbiAgICAgICAgICAgICAgICAgICAgJ3ByaWNlJzogcHJpY2UsXG4gICAgICAgICAgICAgICAgICAgICdjYXRlZ29yeSc6IGNhdGVnb3J5LFxuICAgICAgICAgICAgICAgICAgICAncXVhbnRpdHknOiBxdWFudGl0eVxuICAgICAgICAgICAgICAgICAgfV1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvLyBpZiAoZnJlZV9pdGVtX3V1aWQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgLy8gICB0aGlzLm1hcmtGcmVlSXRlbSh7ZnJlZV9pdGVtX3V1aWR9KTtcbiAgICAgICAgICAgIC8vIH1cbiAgICAgICAgICB9KTtcblxuICAgICAgfSxcblxuICAgICAgb3BlblByb21vY29kZU1vZGFsKGV2dCkge1xuICAgICAgICB3aW5kb3cubW9kYWxzLm9wZW5Nb2RhbFdpbmRvdyhldnQpO1xuICAgICAgfSxcblxuICAgICAgY2xvc2VQcm9tb2NvZGVNb2RhbChldnQpIHtcbiAgICAgICAgd2luZG93Lm1vZGFscy5jbG9zZU1vZGFsV2luZG93KGV2dC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQubW9kYWxDbG9zZSk7XG4gICAgICB9LFxuXG4gICAgICBzZW5kUHJvbW9jb2RlKGV2dCkge1xuICAgICAgICBheGlvc1xuICAgICAgICAgIC5wb3N0KGBhcGkvb3JkZXIvJHt0aGlzLm9yZGVyVVVJRH0vcHJvbW9jb2RlYCwgd2luZG93LnV0aWxzLmNvbGxlY3RGb3JtRGF0YShldnQudGFyZ2V0KSlcbiAgICAgICAgICAudGhlbigoe2RhdGE6IHtvcmRlcl90b3RhbF9wcmljZSwgcHJvbW9jb2RlX2Rpc2NvdW50fX0pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNsb3NlUG9wdXBUaW1lID0gMTUwMDtcblxuICAgICAgICAgICAgdGhpcy5wcm9tb2NvZGUuZGlzY291bnQgPSBwcm9tb2NvZGVfZGlzY291bnQ7XG4gICAgICAgICAgICB0aGlzLnByb21vY29kZS5lcnJvci50ZXh0ID0gbnVsbDtcbiAgICAgICAgICAgIHRoaXMucHJvbW9jb2RlLmVycm9yLnN0YXR1cyA9IGZhbHNlO1xuXG4gICAgICAgICAgICB0aGlzLnJlbmRlck9yZGVyVXBkYXRlUmVzdWx0KHtvcmRlcl90b3RhbF9wcmljZX0pO1xuXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgd2luZG93Lm1vZGFscy5jbG9zZU1vZGFsV2luZG93KCdwcm9tb2NvZGUtbW9kYWwnKTtcbiAgICAgICAgICAgIH0sIGNsb3NlUG9wdXBUaW1lKTtcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5jYXRjaCgoe3Jlc3BvbnNlOiB7ZGF0YToge2RldGFpbH19fSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5wcm9tb2NvZGUuZXJyb3IudGV4dCA9IGRldGFpbDtcbiAgICAgICAgICAgIHRoaXMucHJvbW9jb2RlLmVycm9yLnN0YXR1cyA9IHRydWU7XG4gICAgICAgICAgfSk7XG4gICAgICB9LFxuXG4gICAgICByZW1vdmVQcm9tb2NvZGUoKSB7XG4gICAgICAgIGNvbnN0IGZldGNoRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuXG4gICAgICAgIGZldGNoRGF0YS5hcHBlbmQoJ2NzcmZtaWRkbGV3YXJldG9rZW4nLCB3aW5kb3cudXRpbHMuY3NyZlRva2VuKTtcblxuICAgICAgICBheGlvc1xuICAgICAgICAgIC5wb3N0KGAvYXBpL29yZGVyLyR7dGhpcy5vcmRlclVVSUR9L3Byb21vY29kZS9yZW1vdmVgLCBmZXRjaERhdGEpXG4gICAgICAgICAgLnRoZW4oKHtkYXRhOiB7b3JkZXJfdG90YWxfcHJpY2V9fSkgPT4ge1xuXG4gICAgICAgICAgICB0aGlzLnJlbmRlck9yZGVyVXBkYXRlUmVzdWx0KHtvcmRlcl90b3RhbF9wcmljZX0pO1xuXG4gICAgICAgICAgICB0aGlzLnByb21vY29kZS5lcnJvci50ZXh0ID0gbnVsbDtcbiAgICAgICAgICAgIHRoaXMucHJvbW9jb2RlLmVycm9yLnN0YXR1cyA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5wcm9tb2NvZGUuZGlzY291bnQgPSAwO1xuICAgICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0sXG4gIH0pO1xufSkoKTsiXX0=
